<% layout('layouts/MilitaryUnit.ejs') -%>
<link rel="stylesheet" href="/public/css/icon.css">
<div class="back icon">
    <button class="back-arrow icon"
            onclick="history.back();">
    </button>
</div>

<div class="add icon">
    <button class="add-plus icon"
            onclick="location.href = '/military-units/<%= militaryUnit.id %>/units/create';">
    </button>
</div>

<h2 class="mb-3 mt-3 position-absolute top-0">Система обліку особового складу в в/ч: <%= militaryUnit.name %></h2>

<div class="units">
    <% for(const unit of units){ %>
        <% if(unit){ %>
            <div class="unit">
                <h1 class="name-unit"><%= unit.name %></h1>

                <% if(unit.servicemans){ %>
                    <% const servicemans = {id: unit.id, servicemans: unit.servicemans}; %>
                    <%- include('../../includes/Serviceman/table.ejs', servicemans) %>
                <% } %>
                <br>
                <% if(unit.children){ %>
                    <% const units = {id: unit.id, units: unit.children}; %>
                    <%- include('../../includes/Unit/table.ejs',units) %>
                <% } %>

                <% if(unit.children === undefined && unit.servicemans === undefined){ %>
                    <h1 class="pt-3 empty-unit">Цей підрозділ пустий</h1>
                <% } %>

                <div class="group-add-button">
                    <a href="/military-units/<%= militaryUnit.id %>/units/<%= unit.id %>/servicemans/create"
                       class="button text-decoration-none text-white">Додати в/с</a>
                    <a href="/military-units/<%= militaryUnit.id %>/units/<%= unit.id %>/units/create"
                       class="button text-decoration-none text-white">Додати підрозділ</a>
                    <button class="button" value="<%= unit.id%>" onclick="deleteUnit(event)">Видалити</button>
                </div>
            </div>
        <% } %>
    <% } %>
</div>

<script>
    const editServicemans = document.querySelectorAll(`.action.edit`);
    const deleteServicemans = document.querySelectorAll(`.action.delete`);

    function editUnit(event) {
        const button = getButton(event.target);
        const url = location.href.split("/");
        const militaryUnitId = url[url.indexOf("military-units") + 1];
        const [unitId, parentUnitId] = button.value.split("-");
        location.href = `/military-units/${militaryUnitId}/units/${unitId}/edit`;
    }

    function deleteUnit(event) {
        const button = getButton(event.target);
        const url = location.href.split("/");
        const militaryUnitId = url[url.indexOf("military-units") + 1];
        const [unitId] = button.value.split("-");
        fetch(`/military-units/${militaryUnitId}/units/${unitId}/delete`, {
            method: "delete",
        })
            .then((res) => {
                if (res.status === 200) {
                    location.reload();
                }else {
                    console.log(res.status)
                }
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function editServiceman(event) {
        const button = getButton(event.target);
        const url = location.href.split("/");
        const militaryUnitId = url[url.indexOf("military-units") + 1];
        const [servicemanId, unitId] = button.value.split("-");
        location.href = `/military-units/${militaryUnitId}/units/${unitId}/servicemans/${servicemanId}/edit`;
    }

    function deleteServiceman(event) {
        const button = getButton(event.target);
        const url = location.href.split("/");
        const militaryUnitId = url[url.indexOf("military-units") + 1];
        const [servicemanId, unitId] = button.value.split("-");
        fetch(`/military-units/${militaryUnitId}/units/${unitId}/servicemans/${servicemanId}/delete`, {
            method: "delete",
        })
            .then((res) => {
                if (res.status === 200) {
                    location.reload();
                }else {
                    console.log(res.status)
                }
            })
            .catch((error) => {
                console.log(error);
            });;
    }

    function getButton(node) {
        let currentNode = node;
        if (currentNode.tagName === "BUTTON") {
            return currentNode;
        } else {
            return getButton(currentNode.parentNode);
        }
    }
</script>